# Project Memory

- **Character import utilities** live in `src/lib/character-import.js` (parses JSON, validates required attribute dice, defaults missing skills to 0, builds display name).
- **Imported skill dice bounds**: **What** skill dice values are only accepted in the inclusive range `0..10`; any imported skill below `0`, above `10`, or non-integer is normalized to `0` with a warning. **Where** `src/lib/character-import.js` (`toSkillDiceCount`, `parseCharacterImport`). **Evidence** tests `parseCharacterImport sets skill dice below zero to 0` and `parseCharacterImport sets skill dice above 10 to 0` in `src/lib/character-import.test.js`.
- **Canonical skill mappings** live in `src/data/skill-mappings.js` (skill â†’ attribute map used by import flow).
- **Import UI tabs** are implemented in `src/components/DicePoolPanel.jsx` (manual vs import with file input, selectors, and roll/push handling).
- **Import state hook** lives in `src/hooks/useCharacterImport.js` (file loading, validation state, selection state).
- **App integration** wires Dice Pool tabs and roll overrides in `src/App.jsx`.
- **Import summary quick-rolls**: **What** clicking attribute/skill counts triggers rolls with the selected dice. **Where** `src/components/DicePoolPanel.jsx` (`handleSummaryRoll`). **Evidence** summary list items are rendered as buttons that call `handleSummaryRoll`.
- **Full-page dice stage**: **What** the 3D dice canvas is now rendered in a fixed, fullscreen layer behind the UI. **Where** `src/App.jsx` (`dice-stage-fullscreen` wrapper) and `src/App.css` (fullscreen positioning + canvas sizing). **Evidence** the dice tray section was removed and the new wrapper sits above `main` content.
- **Theme styling centralization**: **What** app chrome colors are primarily controlled through CSS variables and component class rules in a single stylesheet. **Where** `src/App.css` (`:root` design tokens + panel/tab/tray selectors). **Evidence** most visual surfaces read from `--ink-*`, `--surface-*`, `--panel`, and related tokens.
- **Global color-scheme integration**: **What** browser form/control theming now tracks resolved app theme (`light`/`dark`) via `data-theme` on document root. **Where** `src/index.css` (`:root[data-theme="dark"]`, `:root[data-theme="light"]`) and `src/App.jsx` (root attribute update effect). **Evidence** `system` mode automatically flips when OS preference changes.
- **Theme preference state flow**: **What** theme preference (`light`, `dark`, `system`) is persisted and resolved from OS setting when `system` is selected. **Where** `src/lib/theme-preference.js` + `src/hooks/useThemePreference.js`. **Evidence** hook loads/saves preference and subscribes to `prefers-color-scheme` media query changes.
- **Theme application boundary**: **What** resolved theme is applied at the document root and consumed by CSS token overrides. **Where** `src/App.jsx` (`document.documentElement.setAttribute("data-theme", resolvedTheme)`) and `src/App.css` (`:root[data-theme="dark"]` token set). **Evidence** header now includes a `Theme` selector and styles switch via token-driven values.
- **Toast architecture reference from Fate Cards**: **What** the reusable toast mechanism follows a context provider + container + hook split with timer-managed auto-dismiss and safe fallback handlers. **Where** reference files in `/tmp/fate-cards/src/components/toast/*.jsx`, `/tmp/fate-cards/src/components/toast/Toast.css`, and `/tmp/fate-cards/src/hooks/useToast.js`; Year Zero integration targets `src/main.jsx` + `src/App.jsx`. **Evidence** Fate Cards wires `<ToastProvider>` in `main.jsx` and emits dice-result toasts from `App.jsx` via `toast.diceResult(...)`.
- **Source-agnostic roll toast design**: **What** roll result toasts are planned to be emitted from a normalized roll-event adapter that accepts both local and remote/API data. **Where** plan in `docs/plans/2026-02-18 Toast Alert Integration Plan.md` and proposed helper `src/lib/roll-toast-event.js`. **Evidence** plan defines normalized event fields (`eventId`, `source`, `actorName`, `action`, outcomes, timestamp) plus dedupe key strategy.
- **Roll toast defaults and overflow policy**: **What** roll-result notifications are fixed to `diceResult` mode, `10000ms` duration, actor label from `actorId`, and pending queue overflow strategy of drop-oldest with max 20 pending. **Where** `docs/plans/2026-02-18 Toast Alert Integration Plan.md` and `docs/DECISIONS.md` (2026-02-18 entry). **Evidence** user-confirmed answers applied to plan and decisions log.
- **Primary action controls location**: **What** push/clear controls now live in the main dice pool panel footer instead of the removed tray results panel, with desktop side-by-side and mobile stacked layout. **Where** `src/components/DicePoolPanel.jsx` (`panel-action-row`) and `src/App.css` (`.panel-action-row`, responsive overrides). **Evidence** App now passes push/clear props directly to `DicePoolPanel` and no longer renders `.tray-panel`.
- **Manual tab input lifecycle**: **What** Manual attribute/skill number fields now keep draft string values while editing (including empty strings), and are normalized only when `Roll Dice` is pressed. **Where** `src/components/DicePoolPanel.jsx` (`manualAttributeInput`, `manualSkillInput`, `commitManualCounts`, `handleManualPrimaryAction`). **Evidence** tests `manual inputs can be cleared while editing` and `manual roll validates and commits counts before rolling` in `src/components/DicePoolPanel.test.jsx`.
- **Toast stack shift animation**: **What** regular toast items now animate upward when their layout position changes (for example when a new toast appears), using a FLIP-style `getBoundingClientRect` delta in `useLayoutEffect`; dice result text is set to `1.5rem`. **Where** `src/components/toast/ToastContainer.jsx` (`toastPositionMapRef` and layout effect) and `src/components/toast/Toast.css` (`.toast-result-text`). **Evidence** toast list rerender test in `src/components/toast/ToastContainer.test.jsx` covers add-toast update path.
- **Clear action toast guard**: **What** local toast emission now requires a non-null `currentRoll`, preventing stale-history clear actions from being normalized into synthetic `0 successes, 0 banes` toasts after dedupe TTL expiry. **Where** `src/App.jsx` (local roll toast `useEffect`). **Evidence** `clear state does not emit a synthetic local roll toast` in `src/App.toast-integration.test.jsx`.
- **Toast timeout progress indicator**: **What** timed toasts render a bottom fill bar that progresses from 0% to 100% over each toast's `duration` so expiry timing is visible. **Where** `src/components/toast/ToastContainer.jsx` (`toast-progress-bar` render gate on positive `duration`) and `src/components/toast/Toast.css` (`@keyframes toast-progress-fill`). **Evidence** `renders a timed progress bar when toast duration is set` in `src/components/toast/ToastContainer.test.jsx`.
